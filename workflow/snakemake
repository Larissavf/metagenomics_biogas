SAMPLES = ['A', 'B', 'C']



rule fastqc:
    input:
        'fastq/{sample}.fastq'

    output:
        'qc/fastqc/{sample}.html'

    shell:

        "fastqc {input} --outdir qc/fastqc/"



rule trimming:
    input:
        "fastq/{sample}.fastq"
    output:
        "qc/trimmed/{sample}_trimmed.fastq"
    shell:
        "trimmomatic SE -phred33 {input} qc/trimmed/{sample}_trimmed.fastq LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15 MINLEN:36"



rule bwa_map:
    input:
        'data/genome.fa',
        'data/samples/{sample}.fastq'

    output:
        'mapped_reads/{sample}.bam'

    shell:
        'bwa mem {input} | samtools view -Sb - > {output}'


rule samtools_sort:
    input:
        'mapped_reads/{sample}.bam'
    output:
        'sorted_reads/{sample}.bam'
    shell:
        'samtools sort -T sorted_reads/{wildcards.sample} '
        '-O bam {input} > {output}'


rule samtools_index:
    input:
        'sorted_reads/{sample}.bam'
    output:
        'sorted_reads/{sample}.bam.bai'
    shell:
        'samtools index {input}'


rule bcftools_call:
    input:
        fa='data/genome.fa',
        bam=expand('sorted_reads/{sample}.bam', sample=SAMPLES),
        bai=expand('sorted_reads/{sample}.bam.bai',sample=SAMPLES)

    output:
        'calls/all.vcf'
    shell:
        'bcftools mpileup -f {input.fa} {input.bam} | '
        'bcftools call -mv - > {output}'
