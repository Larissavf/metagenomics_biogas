import os
configfile: 'config/config.yaml'

d = {}
for sample_name in config['test']:
    basename = os.path.splitext(sample_name)
    basename = os.path.basename(basename[0])
    d[basename] = sample_name

OD = config["output_dir"]
samples = list(d.keys()))

rule all:
    input:
        expand(OD +'taxonomy/{sample}_output.txt', sample=samples),
        expand(OD +'qc/nanoqc/{sample}.html', sample=samples),
        expand(OD + 'human3/{sample}', sample=samples)


rule nanoqc:
    input:
        lambda wildcards: d[wildcards.sample]
    output:
        OD+'qc/nanoqc/{sample}.html'
    params:
        x_axis = "20",
        y_axis = "20"
    shell:
        "nanoQC -o {output} {input}"

rule nanofilt:
    input:
        lambda wildcards: d[wildcards.sample]
    output:
        OD + 'qc/nanofilt/{sample}.fastq'
    shell:
        'NanoFilt --headcrop 40 --tailcrop 20 --quality 15 {input} > {output}' 

rule kraken2:
    input:
        OD + 'qc/nanofilt/{sample}.fastq'
    output:
        OD + 'taxonomy/{sample}_output.txt'
    log:
        OD + 'log/k2_report.log'
    shell:
        'kraken2 --db /data/datasets/KRAKEN2_INDEX/k2_standard_20231009/ --report {log} --output {output} {input}'

#human3 is a package in biobakery
rule human3:
    input:
        OD + 'qc/nanofilt/{sample}.fastq'
    output:
        OD + 'human3/{sample}'
    shell:
        "humann --input {input} --output {output}"